WITH jore3_route AS (
    -- This route geometry data is copyright Â© by 2021 Helsingin seudun liikenne (HSL) and licensed under a Creative Commons Attribution 4.0 International License (https://creativecommons.org/licenses/by/4.0/).
    SELECT ST_GeomFromEWKT('SRID=4326;LINESTRING(25.020921155 60.168768989,25.021207367 60.168703952,25.022066833 60.168535759,25.022552822 60.168523035,25.023185679 60.168598938,25.026060169 60.168926792,25.027108116 60.169026392,25.027777014 60.169101993,25.028158312 60.169197775,25.028523284 60.169347538,25.02894762 60.169667387,25.029244768 60.169952317,25.029597076 60.170272723,25.02993166 60.170602242,25.030302555 60.170940453,25.030450297 60.171055995,25.030578905 60.171135781,25.030798413 60.171241788,25.031090249 60.171356209,25.031744849 60.171548592,25.031999543 60.171627395,25.032163335 60.171679977,25.032254519 60.171715172,25.032343451 60.171678575,25.032505556 60.171677312,25.032633326 60.171730174,25.032653872 60.171810799,25.032618975 60.171846976,25.032584359 60.171892126,25.032601808 60.171874038,25.033480458 60.172315999,25.034176755 60.172687568,25.034582613 60.172989591,25.034708699 60.172988607,25.034872503 60.173041186,25.034875324 60.173130925,25.03480525 60.173194305,25.035376904 60.173611722,25.035542688 60.173727117,25.035982055 60.173948088,25.036402002 60.17412433,25.037364323 60.17435916,25.038377583 60.174494848,25.03944489 60.174630104,25.0413611 60.174830496,25.041795407 60.174889917,25.0437125 60.175117197,25.044508222 60.175209669,25.045629048 60.175326502,25.045610749 60.17531767,25.04584464 60.175306849,25.046043644 60.175332208,25.046171165 60.175376083,25.046676971 60.175416972,25.047164194 60.175440053,25.047613961 60.175418548,25.048890921 60.17534562,25.049738414 60.175365842,25.049935155 60.175884902,25.050265162 60.17662731,25.050466217 60.177280978,25.050537164 60.177810009,25.050570078 60.178276509,25.050536948 60.178932031,25.050447191 60.179507217,25.050337123 60.180010754,25.050142412 60.180685508,25.049754377 60.181514387,25.049532753 60.181911092,25.049345442 60.182253668,25.049071187 60.182695669,25.0487423 60.18312015,25.048307584 60.183617275,25.048010425 60.183906861,25.047730423 60.184169381,25.047378913 60.184450419,25.046991646 60.184740713,25.046408448 60.185104362,25.045449119 60.185542783,25.045058116 60.185716411,25.043351327 60.186456917,25.043084732 60.186575704,25.042359006 60.186994312,25.041883839 60.187357091,25.041448963 60.187854194,25.041139083 60.18831441,25.040847499 60.188783457,25.040232237 60.189847468,25.039960068 60.190361242,25.039859314 60.190595411,25.039830364 60.190820041,25.039819435 60.19104453,25.039905995 60.191501634,25.039929126 60.191663023,25.03989677 60.191779967,25.039846675 60.191906025,25.039531345 60.192195733,25.039460388 60.192232194,25.037885426 60.192594595,25.035954488 60.193103377,25.035238358 60.193261562,25.034719915 60.193400249,25.033986878 60.193594463,25.033038675 60.193826254,25.032697352 60.193864816,25.032266472 60.193922027,25.031926555 60.194005457,25.031551433 60.194116088,25.031104775 60.194245226,25.030943966 60.194291356,25.030235096 60.194682837,25.030182711 60.1947371,25.030807069 60.195100271)') AS geom
),
match_params AS (
    SELECT
        -- Digiroad stops on both ends of Jore3 route are searched within this given radius (in meters).
        20 AS route_endpoint_search_radius,
        -- The radius (in meters) used to expand Jore3 route to filter applicable Digiroad links.
        20 AS route_expand_radius
),
jore3_route_3067 AS (
    SELECT ST_Transform(geom, 3067) AS geom FROM jore3_route
),
route_endpoints AS (
    SELECT 'start' AS endpoint_type, ST_StartPoint(geom) AS geom FROM jore3_route_3067
    UNION
    SELECT 'end', ST_EndPoint(geom) FROM jore3_route_3067
),
route_terminal_info AS (
    -- Find terminal links on both route endpoints by first resolving closest Digiroad stop and then get links.
    SELECT
        rep.endpoint_type,
        closest_dr_stop.stop_gid,
        closest_dr_stop.dist,
        link.gid AS link_gid,
        link.link_id
    FROM route_endpoints rep, match_params p
    CROSS JOIN LATERAL (
        SELECT
            dr_stop.gid AS stop_gid, 
            rep.geom <-> dr_stop.geom AS dist
        FROM routing.dr_pysakki dr_stop
        WHERE ST_DWithin(rep.geom, dr_stop.geom, p.route_endpoint_search_radius)
        ORDER BY rep.geom <-> dr_stop.geom
        LIMIT 1
    ) AS closest_dr_stop
    INNER JOIN routing.dr_pysakki stop ON stop.gid = closest_dr_stop.stop_gid
    INNER JOIN routing.dr_linkki link USING (link_id)
),
edge_query AS (
    -- Construct edge query for pgr_dijkstra function.
    SELECT query.txt
    FROM (
        SELECT array_to_string(array_agg(link_gid), ',') AS txt
        FROM route_terminal_info
    ) terminal_link_gids, match_params p
    CROSS JOIN LATERAL (
        -- Filtering edges in WHERE clause.
        SELECT 'SELECT gid AS id, source, target, cost, reverse_cost'
            || ' FROM routing.dr_linkki'
            || ' WHERE gid IN (' || terminal_link_gids.txt || ')'
            || ' OR ST_Contains(ST_Buffer(ST_Transform(ST_GeomFromEWKT(''' || ST_AsEWKT(geom) || '''), 3067), ' || p.route_expand_radius || '), geom)' AS txt
        FROM jore3_route
    ) query
),
shortest_path_alternatives AS (
    SELECT paths.*
    FROM edge_query query
    CROSS JOIN (
        -- Produce 2 start points for both endpoints of the first link.
        SELECT source AS vertex_id
        FROM route_terminal_info rti
        INNER JOIN routing.dr_linkki l ON l.gid = rti.link_gid
        WHERE rti.endpoint_type = 'start'
        UNION
        SELECT target
        FROM route_terminal_info rti
        INNER JOIN routing.dr_linkki l ON l.gid = rti.link_gid
        WHERE rti.endpoint_type = 'start'
    ) AS start_vertices
    CROSS JOIN (
        -- Produce 2 end points for both endpoints of the last link.
        SELECT source AS vertex_id
        FROM route_terminal_info rti
        INNER JOIN routing.dr_linkki l ON l.gid = rti.link_gid
        WHERE rti.endpoint_type = 'end'
        UNION
        SELECT target
        FROM route_terminal_info rti
        INNER JOIN routing.dr_linkki l ON l.gid = rti.link_gid
        WHERE rti.endpoint_type = 'end'
    ) AS end_vertices
    CROSS JOIN LATERAL (
        -- Produce 4 path alternatives by 4 permutations on 2 different endpoints on both ends of the route.
        SELECT
            start_vertices.vertex_id AS start_vertex,
            end_vertices.vertex_id AS end_vertex,
            seq,
            path_seq,
            node,
            edge,
            pt.cost,
            agg_cost,
            ST_AsText(geom) AS geom
        FROM pgr_dijkstra(
            query.txt,
            start_vertices.vertex_id,
            end_vertices.vertex_id,
            TRUE -- directed
        ) AS pt
        INNER JOIN routing.dr_linkki link ON pt.edge = link.gid
    ) AS paths
),
shortest_path_link_counts AS (
    SELECT start_vertex, end_vertex, count(seq) AS link_count
    FROM shortest_path_alternatives
    GROUP BY start_vertex, end_vertex
),
shortest_path_result AS (
    -- Select the longest path alternative.
    SELECT spa.seq, spa.path_seq, spa.node, spa.edge, spa.cost, spa.agg_cost, spa.geom
    FROM (
        SELECT start_vertex, end_vertex
        FROM shortest_path_link_counts
        ORDER BY link_count DESC
        LIMIT 1
    ) t
    INNER JOIN shortest_path_alternatives spa ON spa.start_vertex = t.start_vertex AND spa.end_vertex = t.end_vertex
    ORDER BY seq
),
compound_line AS (
    SELECT ST_LineMerge(ST_Collect(ST_SetSRID(geom, 3067))) AS geom
    FROM shortest_path_result
)
-- SELECT * FROM route_terminal_info;
-- SELECT * FROM edge_query;
-- SELECT * FROM shortest_path_result;
SELECT ST_AsGeoJSON(ST_Transform(geom, 4326)) AS geojson FROM compound_line;

-- GeoJSON result:
--  {"type":"LineString","coordinates":[[25.01999978,60.168921482],[25.02029716,60.168846428],[25.020773448,60.168736529],[25.021079766,60.168671963],[25.021228285,60.168628096],[25.021374887,60.168582835],[25.021439683,60.168648561],[25.021699372,60.168600093],[25.021982207,60.16855488],[25.022204998,60.168537853],[25.022421237,60.168532359],[25.022624951,60.16854122],[25.022901968,60.168571194],[25.023585765,60.168643495],[25.024916064,60.168801462],[25.025530801,60.168868871],[25.026365813,60.16896785],[25.026552681,60.168990761],[25.027469048,60.169096658],[25.027858117,60.169150771],[25.028179373,60.169233154],[25.028380236,60.169313745],[25.02858499,60.169428075],[25.028753605,60.169556508],[25.028863698,60.169656253],[25.029085788,60.16987333],[25.029461735,60.170220092],[25.029705694,60.170458313],[25.029730906,60.170481609],[25.029842012,60.170587404],[25.030015691,60.170752771],[25.030396202,60.171044423],[25.030806083,60.171271681],[25.031316311,60.171441957],[25.031753858,60.171574291],[25.03204742,60.171663034],[25.032191576,60.171709859],[25.03229643,60.171747397],[25.032430386,60.171797779],[25.032650538,60.171906529],[25.033015482,60.172093126],[25.033314861,60.172251453],[25.033734218,60.172464911],[25.034033974,60.172617027],[25.03423672,60.172725516],[25.034402276,60.172830964],[25.034518419,60.172929483],[25.034585721,60.173012376],[25.034667548,60.1731017],[25.034742784,60.173113989],[25.034804387,60.173124828],[25.034872445,60.173153132],[25.034940263,60.17318517],[25.03509128,60.173284205],[25.03529083,60.173446005],[25.035653494,60.17367102],[25.036054686,60.173876755],[25.03634489,60.174001429],[25.036745338,60.17413642],[25.037277381,60.174278326],[25.037610005,60.174339091],[25.037952814,60.174396288],[25.038224198,60.174429847],[25.038265583,60.17441458],[25.038346253,60.174398394],[25.038436218,60.17439352],[25.038562695,60.174436932],[25.038619555,60.174535225],[25.038803343,60.174544241],[25.039327558,60.174614475],[25.040186606,60.174710425],[25.040860363,60.174788433],[25.041061427,60.174811021],[25.04135542,60.174844063],[25.042001942,60.174919642],[25.042832318,60.175016237],[25.043516728,60.175096005],[25.043805182,60.175126472],[25.044243751,60.175172618],[25.044842303,60.175236175],[25.045619054,60.175320106],[25.04595301,60.175363427],[25.046379097,60.175408564],[25.046779507,60.175439193],[25.047297087,60.175455605],[25.047866259,60.175451174],[25.047998444,60.175407512],[25.04919035,60.175398038],[25.049523328,60.175392898],[25.04962662,60.17539131],[25.049710559,60.175388962],[25.049751493,60.175452373],[25.049814913,60.175617581],[25.050036826,60.176092985],[25.050232851,60.176562699],[25.050343731,60.176887849],[25.050467432,60.177327982],[25.05052673,60.177717958],[25.050552442,60.178123372],[25.050564071,60.1783147],[25.050558385,60.178666714],[25.050513945,60.179103664],[25.050433108,60.179537717],[25.050420714,60.179592565],[25.050324095,60.17999503],[25.050200401,60.180407641],[25.050088713,60.180728709],[25.050004029,60.180971458],[25.049795715,60.181453141],[25.049540319,60.18195355],[25.049314938,60.182330893],[25.048923874,60.182910443],[25.048616116,60.183323415],[25.048245802,60.183727687],[25.047890097,60.184075912],[25.047763684,60.184199443],[25.047378705,60.184500495],[25.046918581,60.184817145],[25.046359625,60.185173473],[25.045942655,60.185400041],[25.044983232,60.18584402],[25.043689223,60.186382113],[25.043100613,60.186668966],[25.042602858,60.186943066],[25.04222365,60.187197942],[25.041941008,60.18741151],[25.041736783,60.187615987],[25.041529724,60.187854049],[25.041339968,60.188141614],[25.041229466,60.188334326],[25.040943825,60.188830347],[25.040326593,60.189871431],[25.040192667,60.190108623],[25.040055283,60.190365336],[25.039946938,60.190645327],[25.039909954,60.190927343],[25.039937691,60.191253787],[25.040004579,60.191457905],[25.040027348,60.191611469],[25.04002224,60.191770333],[25.039975294,60.191899972],[25.039899765,60.192008602],[25.039815675,60.192106812],[25.039677786,60.192225738],[25.039554605,60.192287085],[25.039464566,60.192317773],[25.036084839,60.193138123],[25.035888284,60.193189784],[25.034071943,60.193658424],[25.033767845,60.193731884],[25.033400675,60.19379398],[25.032950551,60.193844739],[25.032833669,60.193850864],[25.032606554,60.193878893],[25.032318439,60.193929055],[25.032026195,60.193993921],[25.031792337,60.194054991],[25.031504304,60.194130553],[25.030997378,60.194274447],[25.030841378,60.194294817],[25.03069019,60.194471199],[25.030287967,60.194697418],[25.030253751,60.194768943],[25.030275834,60.194806832],[25.030371489,60.194869006],[25.031840735,60.195574026]]}
